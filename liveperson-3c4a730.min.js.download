(function () {
  'use strict';

  const STORAGE_KEYS={SECTION:"lpDtm-section",TAGLET_SECTION:"lpDtm-tagletSection",TOPIC:"lpDtm-topic",BROWSER_SUPPORT:"lpDtm-browserSupport",INITIATOR:"skybot:chat-initiator",SKY_ASSISTANT_CONVO_ID:"skybot:conversationId",SKYBOT_LIVEPERSON_ACTIVE:"skybot:livePersonActive"};function setStorageItem(a,b){let c=!!(2<arguments.length&&arguments[2]!==void 0)&&arguments[2];try{!0===c?window.sessionStorage.setItem(a,b):window.localStorage.setItem(a,b);}catch(a){}}function getStorageItem(a){let b=!!(1<arguments.length&&arguments[1]!==void 0)&&arguments[1],c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:void 0;try{return !0===b?window.sessionStorage.getItem(a):window.localStorage.getItem(a)}catch(a){return c}}function removeStorageItem(a){let b=!!(1<arguments.length&&arguments[1]!==void 0)&&arguments[1];try{return !0===b?window.sessionStorage.removeItem(a):window.localStorage.removeItem(a)}catch(a){}}

  class BrowserSupport{constructor(a,b,c){let d=!!(3<arguments.length&&arguments[3]!==void 0)&&arguments[3];this.pingTimeout=5e3,this.pingDuration=1e3,this.pingCount=0,this.cb=a,this.isBrowserSupported=void 0,this.useSessionState=d,this.logger=b,this.shouldLog=c,this.init();}init(){this.isBrowserSupported=this.getStoredBrowserSupport(),this.isBrowserSupported===void 0||!1===this.useSessionState?window.lpTag.events.bind({appName:"LPTAG",eventName:"ON_STARTED",triggerOnce:!0,func:this.checkEmbeddedSupported.bind(this)}):this.cb(this.isBrowserSupported);}checkEmbeddedSupported(){if(this.logger.info("Checking embedded support",{key:"app.livepersonDtm.checkEmbeddedSupported",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),custom:{url:window.location.href}},this.shouldLog),window.lpTag.taglets&&window.lpTag.taglets.lpUnifiedWindow&&window.lpTag.taglets.lpUnifiedWindow.inspect().conf&&window.lpTag.taglets.lpUnifiedWindow.inspect().conf.embeddedSupported){this.isBrowserSupported=window.lpTag.taglets.lpUnifiedWindow.inspect().conf.embeddedSupported,this.logger.info("Setting isBrowserSupported: ".concat(this.isBrowserSupported),{key:"app.livepersonDtm.checkEmbeddedSupported.isBrowserSupported",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID)||"Conversation ID not found",custom:{url:window.location.href}},!0),this.cb(this.isBrowserSupported),this.setStoredBrowserSupport();const a=this.isBrowserSupported?"embeddedsupported":"embeddedNotSupported",b={type:"service",service:{topic:a,status:0}};window.lpTag.sdes.send?(this.logger.info("Sending ".concat(a," to LP"),{key:"app.livepersonDtm.checkEmbeddedSupported.lpTag.sdes.send",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),custom:{url:window.location.href}},this.shouldLog),window.lpTag.sdes.send(b)):(this.logger.info("Pushing ".concat(a," to LP"),{key:"app.livepersonDtm.checkEmbeddedSupported.lpTag.sdes.push",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),custom:{url:window.location.href}},this.shouldLog),window.lpTag.sdes.push(b));}else if(this.pingCount++,this.pingDuration*this.pingCount>=this.pingTimeout){var a,b,c,d,e,f,g,h;this.isBrowserSupported=!1;const i=window.lpTag.taglets?void 0:"LP Taglets Undefined",j=null!==(a=window.lpTag.taglets)&&void 0!==a&&a.lpUnifiedWindow?void 0:"LP Unified Window Undefined",k=null!==(b=window.lpTag.taglets)&&void 0!==b&&null!==(c=b.lpUnifiedWindow)&&void 0!==c&&null!==(d=c.inspect())&&void 0!==d&&d.conf?void 0:"LP Config Undefined",l=null!==(e=window.lpTag.taglets)&&void 0!==e&&null!==(f=e.lpUnifiedWindow)&&void 0!==f&&null!==(g=f.inspect())&&void 0!==g&&null!==(h=g.conf)&&void 0!==h&&h.embeddedSupported?void 0:"Not supported";this.logger.info("Limit reached, setting browserSupported to false. Reason: ".concat(i||j||k||l),{key:"app.livepersonDtm.checkEmbeddedSupported.pingTimeout",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID)||"Conversation ID not found",custom:{url:window.location.href}},!0),this.cb(this.isBrowserSupported);}else setTimeout(this.checkEmbeddedSupported.bind(this),this.pingDuration);}setStoredBrowserSupport(){setStorageItem(STORAGE_KEYS.BROWSER_SUPPORT,this.isBrowserSupported,!0);}getStoredBrowserSupport(){const a=getStorageItem(STORAGE_KEYS.BROWSER_SUPPORT,!0);if(a)try{const b=JSON.parse(a);return !0===b||!1===b?b:void 0}catch(a){}}}

  const query={query:"\n    query getProfileID {\n      me {\n        profileID\n      }\n    }\n"};class LivePerson{constructor(a,b,c,d,e){this.dom=a,this.auth=b,this.global=c,this.config=d,this.engagementId=0,this.browserSupport=void 0,this.browserSupportCb,this.hasLoaded=!1,this.hasLivePersonLoaded=!1,this.logger=e,this.shouldLog=!!getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),this.init();}init(){this.dom.loadLivepersonScript(),this.browserSupport=new BrowserSupport(this.onBrowserSupportDetermined.bind(this),this.logger,this.shouldLog),this.exposePageEvents(),this.initLivePerson(),this.identities(),this.initSkyBotWebAssistant(),this.exposeIdentifyFunction(),window.addEventListener("visibilitychange",()=>{if(document.hidden||!window.lpTag.taglets)return;const a=document.getElementById(window.lpTag.taglets.lpUnifiedWindow.inspect().conf.wrapperElementId),b=a&&a.getElementsByTagName("TEXTAREA")[0];b&&b.focus();});}identities(){(this.auth.getSSOToken()||this.auth.getOAuthToken())&&(this.logger.info("Fetching identities from SkyPort",{key:"app.livepersonDtm.identites.fetch",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),custom:{url:window.location.href}},this.shouldLog),window.fetch(this.config.skyportUrl,{method:"POST",headers:{"x-api-token":"".concat("7c6e1020-d36b-0139-b7dd-624adf4e86a6"),Authorization:"Bearer ".concat(this.auth.getSSOToken()||this.auth.getOAuthToken()),"Content-Type":"application/json"},credentials:"omit",body:JSON.stringify(query)}).then(a=>{if(a.ok)return a.json()}).then(a=>{const b=a&&a.data&&a.data.me&&a.data.me.profileID;b&&(window.lpTag.identities=[],window.lpTag.identities.push(a=>a({iss:"Sky",acr:"loa1",sub:b})));}).catch(a=>{this.logger.error("Error fetching identities from SkyPort: ".concat(a.message),{key:"app.livepersonDtm.identites.fetch",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),stack:a.stack,custom:{url:window.location.href}},this.shouldLog);}));}initLivePerson(a){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",this.setupDom.bind(this)):this.setupDom(),window.lpTag.events.bind("lp_SMT","MONITORING_STATE",a=>{this.hasLivePersonLoaded=a.active,this.logger.info("Setting hasLivePersonLoaded to ".concat(a.active),{key:"app.livepersonDtm.hasLivePersonLoaded",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),custom:{url:window.location.href}},this.shouldLog),this.finishedCallback();}),this.bindEngagmentId(),this.auth.setLivePersonAuthCallback(),this.exposeChatOpeningEvent(),this.hasLoaded=!0,a&&a(),this.finishedCallback();}onBrowserSupportDetermined(a){this.global.browser={supported:a},this.isBrowserSupported=a,this.logger.info("Setting browser supported to ".concat(a),{key:"app.livepersonDtm.onBrowserSupportDetermined",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),custom:{url:window.location.href}},this.shouldLog),this.browserSupportCb&&a&&this.browserSupportCb(),this.finishedCallback();}setupDom(){this.isBrowserSupported?this.dom.loadPageElements():this.browserSupportCb=this.dom.loadPageElements.bind(this.dom);}bindEngagmentId(){window.lpTag.events.bind("LP_OFFERS","OFFER_IMPRESSION",a=>{this.engagementId=a.engagementId,this.global.engagementId=this.engagementId,setTimeout(()=>{this.logger.info("Dispatching LP_ENGAGEMENT_GOT event",{key:"app.livepersonDtm.bindEngagmentId.lpEngagementGot",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),custom:{url:window.location.href}},this.shouldLog),window.dispatchEvent(new Event("LP_ENGAGEMENT_GOT"));},150);});}exposeChatOpeningEvent(){const a=this.logger;this.global.openLivePersonChat=function(b){b&&!0===b.showChatSurvey&&window.sky&&window.sky.chat?(window.sky.chat.config.set("category",b.preChatCategory||"SAL_Retention"),a.info("Opening pre-chat survey",{key:"app.livepersonDtm.openLivePersonChat.preChatSurvey",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),custom:{url:window.location.href}},this.shouldLog),window.sky.chat.session.create(null,{isWebMessenger:!0},()=>{this.openLivePersonChat();})):(a.info("Opening chat window",{key:"app.livepersonDtm.openLivePersonChat.clickEngagement",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),custom:{url:window.location.href}},this.shouldLog),window.lpTag.taglets.rendererStub.click(this.engagementId));};}exposePageEvents(){var a=this;this.global.onPageChanged||(this.global.onPageChanged=function(){let b=0<arguments.length&&arguments[0]!==void 0?arguments[0]:window.location.href,c=1<arguments.length?arguments[1]:void 0;setStorageItem(STORAGE_KEYS.SECTION,c.section),setStorageItem(STORAGE_KEYS.TAGLET_SECTION,c.tagletSection),setStorageItem(STORAGE_KEYS.TOPIC,c.topic),!0===a.hasLoaded?window.lpTag.newPage(b,c):a.initLivePerson(()=>{window.lpTag.newPage(b,c);});});}exposeIdentifyFunction(){this.global.identifyCustomer||(this.global.identifyCustomer=a=>{a&&(window.lpTag.identities=[],window.lpTag.identities.push(b=>b({iss:"Sky",acr:"loa1",sub:a})));});}loadLivePerson(a){const b=getStorageItem(STORAGE_KEYS.SKYBOT_LIVEPERSON_ACTIVE,!1,!1),c=getStorageItem(STORAGE_KEYS.INITIATOR,!0);b&&new Date().getTime()>new Date(new Date(b).getTime()+172800000).getTime()&&(this.logger.info("Removing livePersonActive",{key:"app.livepersonDtm.loadLivePerson.removeLivePersonActive",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),custom:{url:window.location.href}},this.shouldLog),removeStorageItem(STORAGE_KEYS.SKYBOT_LIVEPERSON_ACTIVE)),"init"===a.state?document.querySelector("#sky-web-assistant-container")&&("skyAssistant"===c?window._hideSkyBotWebAssistant(!1):window._hideSkyBotWebAssistant()):"chatting"===a.state?setStorageItem(STORAGE_KEYS.SKYBOT_LIVEPERSON_ACTIVE,new Date().toISOString()):"ended"===a.state&&removeStorageItem(STORAGE_KEYS.SKYBOT_LIVEPERSON_ACTIVE);}initSkyBotWebAssistant(){window.addEventListener("load",()=>{window.lpTag.events.bind({eventName:"state",appName:"lpUnifiedWindow",func:a=>this.loadLivePerson(a).bind,async:!1});});}finishedCallback(){this.global.browser&&this.hasLoaded&&this.hasLivePersonLoaded&&this.global.onPageChanged&&this.global.openLivePersonChat&&(this.logger.info("Setting readyState to true and dispatching LP_DTM_LOADED event",{key:"app.livepersonDtm.finishedCallback",correlationId:getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),custom:{url:window.location.href}},this.shouldLog),this.global.readyState=!0,window.dispatchEvent(new Event("LP_DTM_LOADED")));}}

  class DomHelper{loadPageElements(){if(!document.getElementById("lpSkyMessagingButton")){const a=document.createElement("div");a.id="lpSkyMessagingButton",a.classList.add("hide"),document.body.appendChild(a);}}loadLivepersonScript(){window.lpTag=window.lpTag||{},window.lpTag.section=window.livepersonDefaultSection||"section",window.lpTag.tagletSection=window.livepersonDefaultTagletSection||"tagletSection",window.lpTag=window.lpTag||{},"undefined"==typeof window.lpTag._tagCount?(window.lpTag={wl:lpTag.wl||null,scp:lpTag.scp||null,site:"66659534",section:lpTag.section||"",tagletSection:lpTag.tagletSection||null,autoStart:!1!==lpTag.autoStart,ovr:lpTag.ovr||{},_v:"1.10.0",_tagCount:1,protocol:"https:",events:{bind:function(a,b,c){lpTag.defer(function(){lpTag.events.bind(a,b,c);},0);},trigger:function(a,b,c){lpTag.defer(function(){lpTag.events.trigger(a,b,c);},1);}},defer:function(a,b){0===b?(this._defB=this._defB||[],this._defB.push(a)):1===b?(this._defT=this._defT||[],this._defT.push(a)):(this._defL=this._defL||[],this._defL.push(a));},load:function(a,b,c){var d=this;setTimeout(function(){d._load(a,b,c);},0);},_load:function(a,b,c){var d=a;a||(d=this.protocol+"//"+(this.ovr&&this.ovr.domain?this.ovr.domain:"lptag.liveperson.net")+"/tag/tag.js?site="+this.site);var e=document.createElement("script");e.setAttribute("charset",b?b:"UTF-8"),c&&e.setAttribute("id",c),e.setAttribute("src",d),document.getElementsByTagName("head").item(0).appendChild(e);},init:function(){this._timing=this._timing||{},this._timing.start=new Date().getTime();var a=this;window.attachEvent?window.attachEvent("onload",function(){a._domReady("domReady");}):(window.addEventListener("DOMContentLoaded",function(){a._domReady("contReady");},!1),window.addEventListener("load",function(){a._domReady("domReady");},!1)),"undefined"==typeof window._lptStop&&this.load();},start:function(){this.autoStart=!0;},_domReady:function(a){this.isDom||(this.isDom=!0,this.events.trigger("LPT","DOM_READY",{t:a})),this._timing[a]=new Date().getTime();},vars:lpTag.vars||[],dbs:lpTag.dbs||[],ctn:lpTag.ctn||[],sdes:lpTag.sdes||[],hooks:lpTag.hooks||[],identities:lpTag.identities||[],ev:lpTag.ev||[]},lpTag.init()):window.lpTag._tagCount+=1;}}

  class Auth{constructor(a,b){this.authServiceUrl=b.authenticatorEndpoint+"/messaging/ssotoken/",this.cookies=a;}setLivePersonAuthCallback(){window.lpGetAuthenticationToken=function(a){const b={};this.getSSOToken()&&(b.skySSO=this.getSSOToken()),this.getOAuthToken()&&(b.skycesa01=this.getOAuthToken());const c=getStorageItem(STORAGE_KEYS.INITIATOR,!0);"skyAssistant"===c?(b["x-skyAssistant-conversationId"]=getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID),this.cookies.getCookie("uuid")&&(b["x-skyAssistant-consumerId"]=this.cookies.getCookie("uuid")),b["x-correlation-id"]=getStorageItem(STORAGE_KEYS.SKY_ASSISTANT_CONVO_ID)):!this.getSSOToken()&&!this.getOAuthToken()&&a(null,"No token");const d=getStorageItem(STORAGE_KEYS.TOPIC)||process.env.TOPIC_DEFAULT;window.fetch(this.authServiceUrl+d,{headers:b}).then(a=>{if(a.ok)return a.json()}).then(b=>{a(b.token);}).catch(b=>{a(null,b);});}.bind(this);}getSSOToken(){return this.cookies.getCookie("skySSO")}getOAuthToken(){return this.cookies.getCookie("skyCEsa01")}}

  class CookieHelper{getCookie(a){let b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:document.cookie;const c="; ".concat(b),d=c.split("; ".concat(a,"="));if(2===d.length)return d.pop().split(";").shift()}deleteCookie(a){document.cookie="".concat(a,"=; Domain=.sky.com; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;");}}

  class Logger{constructor(a,b){this.loggingEndpoint=a,this.loggingApiKey=b;}async log(a,b,c,d){if(d)try{await window.fetch(this.loggingEndpoint,{method:"POST",headers:{"x-correlation-id":c.correlationId,"x-api-token":this.loggingApiKey,"Content-Type":"application/json"},body:JSON.stringify({level:a,key:c.key,message:b,stack:c.stack,custom:c.custom})});}catch(a){}}info(a,b,c){this.log("info",a,b,c);}error(a,b,c){this.log("error",a,b,c);}warn(a,b,c){this.log("warn",a,b,c);}}

  const determineConfig=()=>{if(window.location.hostname.includes("local.bskyb"))return {authenticatorEndpoint:"https://messaging-authenticator.cf.stage-paas.bskyb.com",skyportUrl:"https://skyport-graphql-e05.cf.stage-paas.bskyb.com",loggingEndpoint:"https://dt-ukis-standard-logging-ingester-stage-n01.cf.stage-paas.bskyb.com",loggingApiKey:""};const a=window.location.hostname.match(/-(tdm|u01|e05|uat|e03).cf.(?:dev|stage)-paas.bskyb.com/);switch(a&&a[1]){case"tdm":return {authenticatorEndpoint:"https://messaging-authenticator-tdm.cf.stage-paas.bskyb.com",skyportUrl:"https://skyport-graphql-tdm.cf.stage-paas.bskyb.com",loggingEndpoint:"https://dt-ukis-standard-logging-ingester-stage-n01.cf.stage-paas.bskyb.com",loggingApiKey:"43dbb0a8-e8a5-4044-8def-e1b1bd777dd1"};case"u01":return {authenticatorEndpoint:"https://messaging-authenticator-u01.cf.stage-paas.bskyb.com",skyportUrl:"https://skyport-graphql-u01.cf.stage-paas.bskyb.com",loggingEndpoint:"https://dt-ukis-standard-logging-ingester-stage-n01.cf.stage-paas.bskyb.com",loggingApiKey:"43dbb0a8-e8a5-4044-8def-e1b1bd777dd1"};case"e05":case"uat":return {authenticatorEndpoint:"https://messaging-authenticator.cf.sky.com",skyportUrl:"https://skyport-graphql-e05.cf.stage-paas.bskyb.com",loggingEndpoint:"https://dt-ukis-standard-logging-ingester.cf.sky.com",loggingApiKey:"43dbb0a8-e8a5-4044-8def-e1b1bd777dd1"};case"e03":return {authenticatorEndpoint:"https://messaging-authenticator.cf.sky.com",skyportUrl:"https://skyport-graphql-e03.cf.stage-paas.bskyb.com",loggingEndpoint:"https://dt-ukis-standard-logging-ingester.cf.sky.com",loggingApiKey:"43dbb0a8-e8a5-4044-8def-e1b1bd777dd1"};default:return {authenticatorEndpoint:"https://messaging-authenticator.cf.sky.com",skyportUrl:"https://skyport.sky.com",loggingEndpoint:"https://dt-ukis-standard-logging-ingester.cf.sky.com",loggingApiKey:"43dbb0a8-e8a5-4044-8def-e1b1bd777dd1"}}},config=determineConfig();window.livepersonDtmApi={readyState:!1};const dom=new DomHelper,cookies=new CookieHelper,auth=new Auth(cookies,config),logger=new Logger(config.loggingEndpoint,config.loggingApiKey);new LivePerson(dom,auth,window.livepersonDtmApi,config,logger);

})();
